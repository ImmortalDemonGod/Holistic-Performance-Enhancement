*File to add → `docs/2_requirements/flashcards.md`*  
*(link it from `docs/README.md` and the project Table‑of‑Contents)*  

---

# 📚 Flash‑Memory Layer — Authoring, Build & CI Spec v 1.0

> **Mission** – Guarantee we never re‑learn the same thing twice, while keeping CI fast and the repo small.

---

## 0 · Why flashcards live in the code repo

| Pain‑point | Flash‑memory fix |
|------------|-----------------|
| Tribal knowledge evaporates when people switch projects. | Every durable insight becomes a *version‑controlled card*. |
| Docs read‑once → forgotten. | Spaced‑repetition resurfaces them exactly when you’re about to forget. |
| Unit‑tests guard machines; nothing guards *humans*. | This layer is the **human test‑suite**. |

---

## 1 · Design principles

1. **Author‑first** – editing a card must feel like editing Markdown.  
2. **One canonical source** – *authoring YAML* is truth; everything else is compiled.  
3. **Zero CI drag** – lint/yaml‑schema < 2 s; heavy exports run out‑of‑band.  
4. **Scales to 10⁵ cards** – no megabyte blobs in history; Parquet snapshots for logs.  
5. **Language minimalism** – single Python tool‑chain for parse + export.  
6. **Security** – guard against secrets, XSS, proprietary leaks.

---

## 2 · Folder layout

```text
docs/
└─ 5_flashcards/              # ← author here
   ├─ backend_2025Q2.yaml
   ├─ ml_pipeline.yaml
   └─ taskmaster_cli.yaml

flashcore/                     # Python package
└─ exporters/
   ├─ build_cards.py          # YAML  → DuckDB ingest  (+UUID)
   ├─ export_anki.py          # DuckDB→ .apkg (genanki)
   └─ export_markdown.py      # DuckDB→ flashcards.md

dist/
└─ flashcards/                # auto‑generated (.apkg, .md)
```

> **Rule** – never edit anything in `dist/` or `flashcards/YYYY_MM/` by hand.

---

## 3 · YAML schema (`*.yaml`)

```yaml
deck: Backend::Auth                 # namespaced deck
tags: [backend, auth]
cards:
  - id: 7b7c2d57-e7b8-4e1f-a793-0ee2a61bcb79  # optional; auto‑filled if absent
    q:  "What does the AUTH middleware attach to req in v2?"
    a:  "`req.auth.userId`, `req.auth.scopes`"
    tags: [middleware]
    origin_task: 1423                         # Task Master id
    media: []                                 # optional list of asset paths
  - q: "Which CLI command regenerates task files?"
    a: "`task-master generate`"
```

### Validation rules

| Field | Rule |
|-------|------|
| `deck` | UTF‑8, may include `::` for hierarchy |
| `id` | UUIDv4 (autogenerated if blank) |
| `q`, `a` | ≤ 1024 chars each |
| `tags` | kebab‑case list |
| `media` | path under `docs/5_flashcards/assets/` |
| **Forbidden** | `<script>` tags, absolute file paths, secrets regex |

Run locally:

```bash
python -m flashcore.exporters.build_cards --lint docs/5_flashcards/
```

---

## 4 · Author workflow

### VS Code snippet *(ships in `.vscode/snippets/flashcards.code-snippets`)*

```yaml
- q: "$1question?"
  a: "$2answer"
  tags: [$3]
```

1. Add card into the nearest deck file.  
2. `pre‑commit` hook auto‑runs:

```
tm-fc vet docs/5_flashcards/backend_2025Q2.yaml
```

*Actions*: inject UUIDs, alpha‑sort deck, de‑dupe identical Q fronts.

---

## 5 · Build pipeline

```bash
# one command, run anywhere
make flash-sync
```

1. **Build step** – `build_cards.py`  
   * YAML → internal `Card` objects (fills UUID, normalises Markdown)  
   * Upserts into `duckdb://flash.db cards` table  
2. **Export step** – `export_anki.py`, `export_markdown.py`  
   * Writes `.apkg` (one per top‑level deck) and combined `flashcards.md` into `dist/flashcards/`  
3. **(optional)** – gzip artefacts (`dist/flashcards.zip`) for quick download.

> Average speed: ~7 k cards / s on M2; the largest deck (65 k cards) exports in \< 10 s.

---

## 6 · CI integration

### 6.1 Lint job (cheap; every PR)

`.github/workflows/flashcards-lint.yml`

```yaml
on: [pull_request]
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
      - run: pip install "flashcore[dev]"
      - run: python -m flashcore.exporters.build_cards --lint docs/5_flashcards
```

### 6.2 Build job (heavy; nightly)

`.github/workflows/flashcards-nightly.yml`

```yaml
schedule: [{ cron: "0 22 * * *" }]  # 22:00 UTC
jobs:
  nightly:
    # checkout, setup‑python …
    - run: make flash-sync
    - uses: actions/upload-artifact@v4
      with: { name: flashcards, path: dist/flashcards }
```

Failures **do not** block main CI; they ping `#flashcards-alerts`.

---

## 7 · Task Master hooks

*In `scripts/post_task_complete.py`*:

```python
if "[[fc]]" in task.description:
    tm_fc_add(front, back,
              deck=task.labels.domain,
              origin_task=task.id)
```

*`tm_fc_add`* is an alias for `tm-fc add`.

---

## 8 · Security & compliance

| Check | Tool |
|-------|------|
| Secrets / IDs | `detect-secrets` in pre‑commit |
| HTML sanitise | `bleach` in `build_cards.py` |
| Licence footer | `export_anki.py` appends CC‑BY to every back if env `FLASH_LICENCE=CC-BY-4.0`. |

---

## 9 · Scaling guidelines

* **Shard** huge decks by quarter (`backend_2025Q2.yaml`).  
* **Archive** cards with `stability > 900 days` **and** `lapses = 0`; move to `flashcards_archive/`.  
* Review DB size yearly; prune old `reviews/*parquet` beyond research horizon.

---

## 10 · FAQ

| Q | A |
|---|---|
| *Can I embed LaTeX or images?* | Yes – use `$…$` (auto‑KaTeX) or put assets under `docs/5_flashcards/assets/`. |
| *What if two people add the same question?* | `tm-fc vet` flags duplicate fronts at commit time. |
| *Do I have to install Anki?* | No – Streamlit GUI (`tm-fc review --gui`) works in‑browser. `.apkg` is for mobile/offline. |
| *Why YAML not Markdown tables?* | Easier machine‑parse, supports multi‑line answers & metadata without escaping nightmares. |

---

## 11 · Roadmap tickets (MVP → Q2 2025)

| # | Title | Status |
|---|-------|--------|
| 45 | Define JSON‑Schema & lint cmd | ✅ |
| 46 | Port Node builder → Python genanki | 🟡 in‑progress |
| 52 | PR‑checklist bot for missing decks | 🔲 |
| 57 | Selective deck rebuild in CI | 🔲 |
| 60 | Superset “Memory Stability” dashboard | 🔲 |

*(See GitHub project **Flash‑Memory MVP** for live board.)*

---

## 12 · TL;DR cheat‑sheet

```bash
# add a card quickly
tm-fc add -d Backend "Why use FSRS?" "Gives stability & difficulty metrics"

# run local build/test before pushing
make flash-sync && make test

# daily review
tm-fc review --gui
```

> **Never let knowledge rot.**  
> If it matters, put it in a card – the scheduler will handle the rest.
